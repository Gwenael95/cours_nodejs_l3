<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S'inscrire</title>
</head>
    <body>

    <header></header>
        <main>
            <style>
                .flexCenter{
                    display: flex; justify-content: center; align-items: center
                }
                .flexBetween{
                    display: flex; justify-content: space-between; align-items: center
                }
                .flexColumn{
                    flex-direction: column !important;
                }
                .form >*{
                    width: 50%;
                }
            </style>

            <div style="height: 30px;" id="notification">

            </div>
            <form class="flexCenter flexColumn form">
                <div class="flexBetween">
                    <input type="text" name="pseudo" id="pseudo" placeholder="pseudo" required>
                    <label for="pseudo">pseudo</label>
                </div>
                <div class="flexBetween">
                    <input type="email" name="email" id="email"  placeholder="mail" required>
                    <label for="email">mail</label>
                </div>
                <div class="flexBetween">
                    <input type="password" name="password" id="password" required>
                    <label for="password">mot de passe</label>
                </div>
                <div class="flexBetween">
                    <input type="password" name="confirmPassword" id="confirmPassword" required>
                    <label for="confirmPassword">confirmez votre mot de passe</label>
                </div>
                <input type="button" id="submitButton">
            </form>
        </main>
        <footer></footer>


        <script>
            let submitButton = document.getElementById("submitButton")
            submitButton.onclick = function (){
                signin()
            }
            /**
             * @param promise : Promise<Response> :
             */
            function handleFetchLogJson(promise){
                return promise
                    .then(response => response.json())
                    .then(response =>{
                        console.log(response);
                        return response})
                    .catch(e=>console.error(e));
            }

            function getData(inputId){
                return document.getElementById(inputId).value
            }

            async function signin(){
                if (getData("password") === getData("confirmPassword")){
                    const body = JSON.stringify({
                        pseudo: getData("pseudo"),
                        mail: getData("email"),
                        password: getData("password"),
                        confirmPassword: getData("confirmPassword")
                    })
                    const res = await handleFetchLogJson(fetch( '/user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body
                    }));
                    if(res.errors) {
                        if (res.errors.mail && res.errors.mail.kind === "regexp") {
                            document.getElementById("notification").textContent = "Inscription impossible, le mail n'est pas dans un format correct"
                        } else {
                            const errorReason = Object.keys(res.errors)
                            document.getElementById("notification").textContent = "Inscription impossible, " + errorReason.join(" et ") + " déjà utilisé" + (errorReason.length > 1 ? "s" : "")
                        }
                    }
                    else{
                        document.getElementById("notification").textContent = "Inscription réussi"
                        //@todo redirection
                    }
                }
                else{
                    document.getElementById("notification").textContent = "les mots de passes ne sont pas identique"
                }

            }
        </script>
    </body>
</html>